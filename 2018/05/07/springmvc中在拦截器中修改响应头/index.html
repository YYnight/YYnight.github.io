<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Devil"><title>springmvc中在拦截器中修改响应头 . Devil的博客</title><meta name="description" content="&amp;emsp;今天在工作时需要在每次响应时去更新响应头信息，却遇到了无比大坑（自己太菜，以前并没有学习到，哈哈），在Springmvc拦截器中的postHandle方法和afterHandle方法中去添加响应头信息，并不能成功，但是在preHandle中添加却能成功。然后百度了一下才发现，这种情况只有"><meta name="keywords" content="Devil,技术,java,React"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/code_style_dark.css"><script src="/js/scrollReveal.js"></script><script src="/js/jquery.min.js"></script><script src="/js/jscex.min.js"></script><script src="/js/jscex-parser.js"></script><script src="/js/jscex-jit.js"></script><script src="/js/jscex-builderbase.min.js"></script><script src="/js/jscex-async.min.js"></script><script src="/js/jscex-async-powerpack.min.js"></script><script src="/js/functions.js"></script><script src="/js/love.js"></script><script src="/js/filter.js"></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></head><body><div class="header"><div id="banner"><a href="/"><img src="/images/logo.jpg" class="head"></a><h2 id="mmenu"><span class="navicon"></span></h2><div id="slider"><li><a href="/">首页</a></li><li><a href="/blog">博客</a></li><li><a href="/life">生活</a></li><li><a href="/archives">归档</a></li><li><a href="/about">关于我</a></li><li><a href="/code">短码</a></li><li><a href="/photos">相册</a></li></div></div><script type="text/javascript">var mmenu = document.getElementById("mmenu");
var slider = document.getElementById("slider");
mmenu.onclick = function() {
var style = slider.style;
slider.style.display = style.display == "block" ? "none" : "block"
mmenu.className = style.display == "block" ? "open" : ""
}
var as = slider.getElementsByTagName('a');
obj = as[0];
for (var i = 1; i < as.length; i++) {
if (window.location.href.indexOf(as[i].href) >= 0) {
obj = as[i];
}
}
obj.id = 'selected'</script></div><div class="line60"></div><div class="blank"></div><div id="main"><div class="blogcontent size-controll"><div class="pagecontent fadeIn content"><div class="post animated fadeInDown"><div class="post-title"><h3><a>springmvc中在拦截器中修改响应头</a></h3></div><div class="post-content"><p>&emsp;今天在工作时需要在每次响应时去更新响应头信息，却遇到了无比大坑（自己太菜，以前并没有学习到，哈哈），在Springmvc拦截器中的postHandle方法和afterHandle方法中去添加响应头信息，并不能成功，但是在preHandle中添加却能成功。然后百度了一下才发现，这种情况只有在被@ResponseBody注释的方法才会发生。<br>走一下spring的流程查一遍，直接从ServletInvocableHandlerMethod的invokeAndHandle找起：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeAndHandle</span><span class="params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">2</span>             Object... providedArgs)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> <span class="number">3</span> </span><br><span class="line"> <span class="number">4</span>         Object returnValue = invokeForRequest(webRequest, mavContainer, providedArgs);</span><br><span class="line"> <span class="number">5</span>         setResponseStatus(webRequest);</span><br><span class="line"> <span class="number">6</span> </span><br><span class="line"> <span class="number">7</span>         <span class="keyword">if</span> (returnValue == <span class="keyword">null</span>) &#123;</span><br><span class="line"> <span class="number">8</span>             <span class="keyword">if</span> (isRequestNotModified(webRequest) || hasResponseStatus() || mavContainer.isRequestHandled()) &#123;</span><br><span class="line"> <span class="number">9</span>                 mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">10</span>                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">11</span>             &#125;</span><br><span class="line"><span class="number">12</span>         &#125;</span><br><span class="line"><span class="number">13</span>         <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.responseReason)) &#123;</span><br><span class="line"><span class="number">14</span>             mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">15</span>             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">16</span>         &#125;</span><br><span class="line"><span class="number">17</span> </span><br><span class="line"><span class="number">18</span>         mavContainer.setRequestHandled(<span class="keyword">false</span>);</span><br><span class="line"><span class="number">19</span>         <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">20</span>             <span class="keyword">this</span>.returnValueHandlers.handleReturnValue(</span><br><span class="line"><span class="number">21</span>                     returnValue, getReturnValueType(returnValue), mavContainer, webRequest);</span><br><span class="line"><span class="number">22</span>         &#125;</span><br><span class="line"><span class="number">23</span>         <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line"><span class="number">24</span>             <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line"><span class="number">25</span>                 logger.trace(getReturnValueHandlingErrorMessage(<span class="string">"Error handling return value"</span>, returnValue), ex);</span><br><span class="line"><span class="number">26</span>             &#125;</span><br><span class="line"><span class="number">27</span>             <span class="keyword">throw</span> ex;</span><br><span class="line"><span class="number">28</span>         &#125;</span><br><span class="line"><span class="number">29</span>     &#125;</span><br></pre></td></tr></table></figure></p>
<p>进到handleReturnValue这个方法里：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="number">2</span>             ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="number">3</span> </span><br><span class="line"><span class="number">4</span>         HandlerMethodReturnValueHandler handler = selectHandler(returnValue, returnType);</span><br><span class="line"><span class="number">5</span>         <span class="keyword">if</span> (handler == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">6</span>             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown return value type: "</span> + returnType.getParameterType().getName());</span><br><span class="line"><span class="number">7</span>         &#125;</span><br><span class="line"><span class="number">8</span>         handler.handleReturnValue(returnValue, returnType, mavContainer, webRequest);</span><br><span class="line"><span class="number">9</span>     &#125;</span><br></pre></td></tr></table></figure></p>
<p>这是选择对应的处理器处理返回值，继续往下：<br>因为是被@ResponseBody注释的方法，所以我们进到了RequestResponseBodyMethodProcessor的实现里：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>     <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturnValue</span><span class="params">(Object returnValue, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">3</span>             ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span></span></span><br><span class="line"><span class="function"> 4             <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line"> <span class="number">5</span> </span><br><span class="line"> <span class="number">6</span>         mavContainer.setRequestHandled(<span class="keyword">true</span>);</span><br><span class="line"> <span class="number">7</span>         ServletServerHttpRequest inputMessage = createInputMessage(webRequest);</span><br><span class="line"> <span class="number">8</span>         ServletServerHttpResponse outputMessage = createOutputMessage(webRequest);</span><br><span class="line"> <span class="number">9</span> </span><br><span class="line"><span class="number">10</span>         <span class="comment">// Try even with null return value. ResponseBodyAdvice could get involved.</span></span><br><span class="line"><span class="number">11</span>         writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line"><span class="number">12</span>     &#125;</span><br></pre></td></tr></table></figure></p>
<p>前两步是设置了状态，并将原生的request和response封装一下再返回，我们看writeWithMessageConverters里做了什么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>   <span class="keyword">protected</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">writeWithMessageConverters</span><span class="params">(T value, MethodParameter returnType,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">2</span>             ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span></span></span><br><span class="line"><span class="function"> 3             <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line"> <span class="number">4</span> </span><br><span class="line"> <span class="number">5</span>         Object outputValue;</span><br><span class="line"> <span class="number">6</span>         Class&lt;?&gt; valueType;</span><br><span class="line"> <span class="number">7</span>         Type declaredType;</span><br><span class="line"> <span class="number">8</span> </span><br><span class="line"> <span class="number">9</span>         <span class="keyword">if</span> (value <span class="keyword">instanceof</span> CharSequence) &#123;</span><br><span class="line"><span class="number">10</span>             outputValue = value.toString();</span><br><span class="line"><span class="number">11</span>             valueType = String.class;</span><br><span class="line"><span class="number">12</span>             declaredType = String.class;</span><br><span class="line"><span class="number">13</span>         &#125;</span><br><span class="line"><span class="number">14</span>         <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">15</span>             outputValue = value;</span><br><span class="line"><span class="number">16</span>             valueType = getReturnValueType(outputValue, returnType);</span><br><span class="line"><span class="number">17</span>             declaredType = getGenericType(returnType);</span><br><span class="line"><span class="number">18</span>         &#125;</span><br><span class="line"><span class="number">19</span> </span><br><span class="line"><span class="number">20</span>         HttpServletRequest request = inputMessage.getServletRequest();</span><br><span class="line"><span class="number">21</span>         List&lt;MediaType&gt; requestedMediaTypes = getAcceptableMediaTypes(request);</span><br><span class="line"><span class="number">22</span>         List&lt;MediaType&gt; producibleMediaTypes = getProducibleMediaTypes(request, valueType, declaredType);</span><br><span class="line"><span class="number">23</span> </span><br><span class="line"><span class="number">24</span>         <span class="keyword">if</span> (outputValue != <span class="keyword">null</span> &amp;&amp; producibleMediaTypes.isEmpty()) &#123;</span><br><span class="line"><span class="number">25</span>             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No converter found for return value of type: "</span> + valueType);</span><br><span class="line"><span class="number">26</span>         &#125;</span><br><span class="line"><span class="number">27</span> </span><br><span class="line"><span class="number">28</span>         Set&lt;MediaType&gt; compatibleMediaTypes = <span class="keyword">new</span> LinkedHashSet&lt;MediaType&gt;();</span><br><span class="line"><span class="number">29</span>         <span class="keyword">for</span> (MediaType requestedType : requestedMediaTypes) &#123;</span><br><span class="line"><span class="number">30</span>             <span class="keyword">for</span> (MediaType producibleType : producibleMediaTypes) &#123;</span><br><span class="line"><span class="number">31</span>                 <span class="keyword">if</span> (requestedType.isCompatibleWith(producibleType)) &#123;</span><br><span class="line"><span class="number">32</span>                     compatibleMediaTypes.add(getMostSpecificMediaType(requestedType, producibleType));</span><br><span class="line"><span class="number">33</span>                 &#125;</span><br><span class="line"><span class="number">34</span>             &#125;</span><br><span class="line"><span class="number">35</span>         &#125;</span><br><span class="line"><span class="number">36</span>         <span class="keyword">if</span> (compatibleMediaTypes.isEmpty()) &#123;</span><br><span class="line"><span class="number">37</span>             <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">38</span>                 <span class="keyword">throw</span> <span class="keyword">new</span> HttpMediaTypeNotAcceptableException(producibleMediaTypes);</span><br><span class="line"><span class="number">39</span>             &#125;</span><br><span class="line"><span class="number">40</span>             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">41</span>         &#125;</span><br><span class="line"><span class="number">42</span> </span><br><span class="line"><span class="number">43</span>         List&lt;MediaType&gt; mediaTypes = <span class="keyword">new</span> ArrayList&lt;MediaType&gt;(compatibleMediaTypes);</span><br><span class="line"><span class="number">44</span>         MediaType.sortBySpecificityAndQuality(mediaTypes);</span><br><span class="line"><span class="number">45</span> </span><br><span class="line"><span class="number">46</span>         MediaType selectedMediaType = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">47</span>         <span class="keyword">for</span> (MediaType mediaType : mediaTypes) &#123;</span><br><span class="line"><span class="number">48</span>             <span class="keyword">if</span> (mediaType.isConcrete()) &#123;</span><br><span class="line"><span class="number">49</span>                 selectedMediaType = mediaType;</span><br><span class="line"><span class="number">50</span>                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">51</span>             &#125;</span><br><span class="line"><span class="number">52</span>             <span class="keyword">else</span> <span class="keyword">if</span> (mediaType.equals(MediaType.ALL) || mediaType.equals(MEDIA_TYPE_APPLICATION)) &#123;</span><br><span class="line"><span class="number">53</span>                 selectedMediaType = MediaType.APPLICATION_OCTET_STREAM;</span><br><span class="line"><span class="number">54</span>                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">55</span>             &#125;</span><br><span class="line"><span class="number">56</span>         &#125;</span><br><span class="line"><span class="number">57</span> </span><br><span class="line"><span class="number">58</span>         <span class="keyword">if</span> (selectedMediaType != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">59</span>             selectedMediaType = selectedMediaType.removeQualityValue();</span><br><span class="line"><span class="number">60</span>             <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; messageConverter : <span class="keyword">this</span>.messageConverters) &#123;</span><br><span class="line"><span class="number">61</span>                 <span class="keyword">if</span> (messageConverter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class="line"><span class="number">62</span>                     <span class="keyword">if</span> (((GenericHttpMessageConverter) messageConverter).canWrite(</span><br><span class="line"><span class="number">63</span>                             declaredType, valueType, selectedMediaType)) &#123;</span><br><span class="line"><span class="number">64</span>                         outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line"><span class="number">65</span>                                 (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line"><span class="number">66</span>                                 inputMessage, outputMessage);</span><br><span class="line"><span class="number">67</span>                         <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">68</span>                             addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line"><span class="number">69</span>                             ((GenericHttpMessageConverter) messageConverter).write(</span><br><span class="line"><span class="number">70</span>                                     outputValue, declaredType, selectedMediaType, outputMessage);</span><br><span class="line"><span class="number">71</span>                             <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line"><span class="number">72</span>                                 logger.debug(<span class="string">"Written ["</span> + outputValue + <span class="string">"] as \""</span> + selectedMediaType +</span><br><span class="line"><span class="number">73</span>                                         <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line"><span class="number">74</span>                             &#125;</span><br><span class="line"><span class="number">75</span>                         &#125;</span><br><span class="line"><span class="number">76</span>                         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">77</span>                     &#125;</span><br><span class="line"><span class="number">78</span>                 &#125;</span><br><span class="line"><span class="number">79</span>                 <span class="keyword">else</span> <span class="keyword">if</span> (messageConverter.canWrite(valueType, selectedMediaType)) &#123;</span><br><span class="line"><span class="number">80</span>                     outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line"><span class="number">81</span>                             (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line"><span class="number">82</span>                             inputMessage, outputMessage);</span><br><span class="line"><span class="number">83</span>                     <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">84</span>                         addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line"><span class="number">85</span>                         ((HttpMessageConverter) messageConverter).write(outputValue, selectedMediaType, outputMessage);</span><br><span class="line"><span class="number">86</span>                         <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line"><span class="number">87</span>                             logger.debug(<span class="string">"Written ["</span> + outputValue + <span class="string">"] as \""</span> + selectedMediaType +</span><br><span class="line"><span class="number">88</span>                                     <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line"><span class="number">89</span>                         &#125;</span><br><span class="line"><span class="number">90</span>                     &#125;</span><br><span class="line"><span class="number">91</span>                     <span class="keyword">return</span>;</span><br><span class="line"><span class="number">92</span>                 &#125;</span><br><span class="line"><span class="number">93</span>             &#125;</span><br><span class="line"><span class="number">94</span>         &#125;</span><br><span class="line"><span class="number">95</span> </span><br><span class="line"><span class="number">96</span>         <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">97</span>             <span class="keyword">throw</span> <span class="keyword">new</span> HttpMediaTypeNotAcceptableException(<span class="keyword">this</span>.allSupportedMediaTypes);</span><br><span class="line"><span class="number">98</span>         &#125;</span><br><span class="line"><span class="number">99</span>     &#125;</span><br></pre></td></tr></table></figure></p>
<p>虽然写了一大段，但是我们看到对outputMessage进行操作的只有在下面这个for循环里，我们就重点关注下这里操作了什么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>              <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; messageConverter : <span class="keyword">this</span>.messageConverters) &#123;</span><br><span class="line"> <span class="number">2</span>                 <span class="keyword">if</span> (messageConverter <span class="keyword">instanceof</span> GenericHttpMessageConverter) &#123;</span><br><span class="line"> <span class="number">3</span>                     <span class="keyword">if</span> (((GenericHttpMessageConverter) messageConverter).canWrite(</span><br><span class="line"> <span class="number">4</span>                             declaredType, valueType, selectedMediaType)) &#123;</span><br><span class="line"> <span class="number">5</span>                         outputValue = (T) getAdvice().beforeBodyWrite(outputValue, returnType, selectedMediaType,</span><br><span class="line"> <span class="number">6</span>                                 (Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt;) messageConverter.getClass(),</span><br><span class="line"> <span class="number">7</span>                                 inputMessage, outputMessage);</span><br><span class="line"> <span class="number">8</span>                         <span class="keyword">if</span> (outputValue != <span class="keyword">null</span>) &#123;</span><br><span class="line"> <span class="number">9</span>                             addContentDispositionHeader(inputMessage, outputMessage);</span><br><span class="line"><span class="number">10</span>                             ((GenericHttpMessageConverter) messageConverter).write(</span><br><span class="line"><span class="number">11</span>                                     outputValue, declaredType, selectedMediaType, outputMessage);</span><br><span class="line"><span class="number">12</span>                             <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line"><span class="number">13</span>                                 logger.debug(<span class="string">"Written ["</span> + outputValue + <span class="string">"] as \""</span> + selectedMediaType +</span><br><span class="line"><span class="number">14</span>                                         <span class="string">"\" using ["</span> + messageConverter + <span class="string">"]"</span>);</span><br><span class="line"><span class="number">15</span>                             &#125;</span><br><span class="line"><span class="number">16</span>                         &#125;</span><br><span class="line"><span class="number">17</span>                         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">18</span>                     &#125;</span><br><span class="line"><span class="number">19</span>                 &#125;</span><br></pre></td></tr></table></figure></p>
<p>重点应该是在write这个方法里，这里是Converter对内容进行转化。<br>由于我们用的converter是FastJsonHttpMessageConverter，具体实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object t, //</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">2</span>                       Type type, //</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">3</span>                       MediaType contentType, //</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">4</span>                       HttpOutputMessage outputMessage //</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">5</span>     )</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line"> <span class="number">6</span> </span><br><span class="line"> <span class="number">7</span>         HttpHeaders headers = outputMessage.getHeaders();</span><br><span class="line"> <span class="number">8</span>         <span class="keyword">if</span> (headers.getContentType() == <span class="keyword">null</span>) &#123;</span><br><span class="line"> <span class="number">9</span>             <span class="keyword">if</span> (contentType == <span class="keyword">null</span> || contentType.isWildcardType() || contentType.isWildcardSubtype()) &#123;</span><br><span class="line"><span class="number">10</span>                 contentType = getDefaultContentType(t);</span><br><span class="line"><span class="number">11</span>             &#125;</span><br><span class="line"><span class="number">12</span>             <span class="keyword">if</span> (contentType != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">13</span>                 headers.setContentType(contentType);</span><br><span class="line"><span class="number">14</span>             &#125;</span><br><span class="line"><span class="number">15</span>         &#125;</span><br><span class="line"><span class="number">16</span>         <span class="keyword">if</span> (headers.getContentLength() == -<span class="number">1</span>) &#123;</span><br><span class="line"><span class="number">17</span>             Long contentLength = getContentLength(t, headers.getContentType());</span><br><span class="line"><span class="number">18</span>             <span class="keyword">if</span> (contentLength != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">19</span>                 headers.setContentLength(contentLength);</span><br><span class="line"><span class="number">20</span>             &#125;</span><br><span class="line"><span class="number">21</span>         &#125;</span><br><span class="line"><span class="number">22</span>         writeInternal(t, outputMessage);</span><br><span class="line"><span class="number">23</span>         outputMessage.getBody().flush();</span><br><span class="line"><span class="number">24</span>     &#125;</span><br></pre></td></tr></table></figure></p>
<p>看看是不是flush动作导致了response状态改为已经被提交，所以导致设置header失效，试一试：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span>      <span class="meta">@RequestMapping</span>(<span class="string">"queryAuditList"</span>)</span><br><span class="line"> <span class="number">2</span>      <span class="meta">@ResponseBody</span></span><br><span class="line"> <span class="number">3</span>      <span class="meta">@SaveParam</span></span><br><span class="line"> <span class="number">4</span>      <span class="function"><span class="keyword">public</span> JSONObject <span class="title">queryAuditList</span><span class="params">( HttpServletResponse res)</span> </span>&#123;</span><br><span class="line"> <span class="number">5</span>          res.addCookie(<span class="keyword">new</span> Cookie(<span class="string">"befroe"</span>, <span class="string">"1"</span>));</span><br><span class="line"> <span class="number">6</span>          <span class="keyword">try</span> &#123;</span><br><span class="line"> <span class="number">7</span>             res.getOutputStream().flush();</span><br><span class="line"> <span class="number">8</span>         &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line"> <span class="number">9</span>             <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line"><span class="number">10</span>             e.printStackTrace();</span><br><span class="line"><span class="number">11</span>         &#125;</span><br><span class="line"><span class="number">12</span>          res.addCookie(<span class="keyword">new</span> Cookie(<span class="string">"after"</span>, <span class="string">"1"</span>));</span><br><span class="line"><span class="number">13</span>          <span class="keyword">return</span> <span class="keyword">new</span> JSONObject();</span><br><span class="line"><span class="number">14</span>      &#125;</span><br></pre></td></tr></table></figure></p>
<p>果然是这样！</p>
<p>再看下servlet文档里的说法：</p>
<p>isCommitted</p>
<p>public boolean isCommitted()<br>Returns a boolean indicating if the response has been committed. A committed response has already had its status code and headers written.</p>
<p> 划重点：A committed response has already had its status and headers written.</p>
<p>所以flush操作是会导致response的commited状态被修改的，也就是说这时response的头信息已经被确定了！</p>
<p>解决方案：由于Controller方法中已经使用了@ResponseBody注解返回json数据，故不能通过Spring拦截器响应消息头，但是Spring同时还提供了一个ResponseBodyAdvice接口，允许在这种情境下实现对响应消息头的控制。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderModifierAdvice</span> <span class="keyword">implements</span> <span class="title">ResponseBodyAdvice</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">beforeBodyWrite</span><span class="params">(Object body, MethodParameter returnType, MediaType selectedContentType,</span></span></span><br><span class="line"><span class="function"><span class="params">            Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType, ServerHttpRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line">        ServletServerHttpRequest ssReq = (ServletServerHttpRequest)request;</span><br><span class="line">        ServletServerHttpResponse ssResp = (ServletServerHttpResponse)response;</span><br><span class="line">        <span class="keyword">if</span>(ssReq == <span class="keyword">null</span> || ssResp == <span class="keyword">null</span></span><br><span class="line">                || ssReq.getServletRequest() == <span class="keyword">null</span></span><br><span class="line">                || ssResp.getServletResponse() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> body;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 对于未添加跨域消息头的响应进行处理</span></span><br><span class="line">        HttpServletRequest req = ssReq.getServletRequest();</span><br><span class="line">        HttpServletResponse resp = ssResp.getServletResponse();</span><br><span class="line">        String originHeader = <span class="string">"Access-Control-Allow-Origin"</span>;</span><br><span class="line">        <span class="keyword">if</span>(!resp.containsHeader(originHeader)) &#123;</span><br><span class="line">            String origin = req.getHeader(<span class="string">"Origin"</span>);</span><br><span class="line">            <span class="keyword">if</span>(origin == <span class="keyword">null</span>) &#123;</span><br><span class="line">                String referer = req.getHeader(<span class="string">"Referer"</span>);</span><br><span class="line">                <span class="keyword">if</span>(referer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    origin = referer.substring(<span class="number">0</span>, referer.indexOf(<span class="string">"/"</span>, <span class="number">7</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            resp.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, origin);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String credentialHeader = <span class="string">"Access-Control-Allow-Credentials"</span>;</span><br><span class="line">        <span class="keyword">if</span>(!resp.containsHeader(credentialHeader)) &#123;</span><br><span class="line">            resp.setHeader(credentialHeader, <span class="string">"true"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结：对于使用了@ResponseBody注解的场景，如果需要统一调整响应消息头，只能通过自定义ResponseBodyAdvice实现来完成。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-05-07</span><i class="fa fa-tag"></i><a href="/categories/article/" title="article" class="tag">article </a><a href="/tags/Java/" title="Java" class="tag">Java </a><a href="/tags/Spring/" title="Spring" class="tag">Spring </a></div></div></div></div><div class="pagination"><span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span>次</span><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/05/09/WebSocket的简单使用/" title="WebSocket的简单使用" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2018/05/07/nginx的简单命令以及一些配置/" title="nginx的简单命令以及一些配置" class="btn">下一篇</a></li></ul></div><div id="lv-container" data-id="city" data-uid="MTAyMC80MDMyMC8xNjg0Nw=="><script src="/js/libere.js"></script></div></div><div class="rightpane fadeIn"><div class="block aboutme"><div class="content"><h2 class="ab_title">关于我</h2><div class="avatar"><img src="/images/logo.jpg"></div><div class="ab_con"><p>网名：夭夜</p><p>职业：java开发工程师</p><p>微信：Y--night</p><p>邮箱：616834508@qq.com</p></div></div></div><div class="block weixin"><div class="content"><h2 class="wx_title">个人微信</h2><div class="avatar"><img src="/images/weixin.png"></div></div></div><div class="block archives"><h2 class="ar_title">标签</h2><div class="content"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/"><i class="fa" aria-hidden="true">Java</i></a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Js/"><i class="fa" aria-hidden="true">Js</i></a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/"><i class="fa" aria-hidden="true">Spring</i></a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/"><i class="fa" aria-hidden="true">kotlin</i></a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/"><i class="fa" aria-hidden="true">nginx</i></a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/"><i class="fa" aria-hidden="true">springboot</i></a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/加密/"><i class="fa" aria-hidden="true">加密</i></a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/故事/"><i class="fa" aria-hidden="true">故事</i></a><span class="tag-list-count">1</span></li></ul></div></div></div></div></div><div class="footer"></div><script src="/js/xy-nest.js"></script><script>if(!(/msie [6|7|8|9]/i.test(navigator.userAgent))){
    (function(){
        window.scrollReveal = new scrollReveal({reset: true});
    })();
}</script></body></html>